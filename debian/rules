#!/usr/bin/make -f

# Uncomment this to turn on verbose mode.
#export DH_VERBOSE=1

%:
	dh $@ --with python3

override_dh_auto_build:
	# No build step needed - models and library are prepared by build-deb.sh
	true

override_dh_auto_install:
	# Create installation directory structure
	install -d $(CURDIR)/debian/distiller-cm5-sdk/opt/distiller-cm5-sdk
	install -d $(CURDIR)/debian/distiller-cm5-sdk/opt/distiller-cm5-sdk/lib
	install -d $(CURDIR)/debian/distiller-cm5-sdk/opt/distiller-cm5-sdk/models
	install -d $(CURDIR)/debian/distiller-cm5-sdk/opt/distiller-cm5-sdk/bin
	
	# Copy Python source code
	cp -r src $(CURDIR)/debian/distiller-cm5-sdk/opt/distiller-cm5-sdk/
	
	# Clean up unnecessary files from source
	rm -rf $(CURDIR)/debian/distiller-cm5-sdk/opt/distiller-cm5-sdk/src/distiller_cm5_sdk/hardware/eink/lib
	rm -rf $(CURDIR)/debian/distiller-cm5-sdk/opt/distiller-cm5-sdk/src/distiller_cm5_sdk/parakeet/models/*
	rm -rf $(CURDIR)/debian/distiller-cm5-sdk/opt/distiller-cm5-sdk/src/distiller_cm5_sdk/piper/models/*
	rm -rf $(CURDIR)/debian/distiller-cm5-sdk/opt/distiller-cm5-sdk/src/distiller_cm5_sdk/piper/piper/*
	rm -rf $(CURDIR)/debian/distiller-cm5-sdk/opt/distiller-cm5-sdk/src/distiller_cm5_sdk/whisper/models/*
	
	# Copy configuration files
	cp pyproject.toml $(CURDIR)/debian/distiller-cm5-sdk/opt/distiller-cm5-sdk/
	cp README.md $(CURDIR)/debian/distiller-cm5-sdk/opt/distiller-cm5-sdk/
	if [ -f requirements.txt ]; then \
		cp requirements.txt $(CURDIR)/debian/distiller-cm5-sdk/opt/distiller-cm5-sdk/; \
	fi
	
	# Copy model files
	cp -r src/distiller_cm5_sdk/parakeet/models $(CURDIR)/debian/distiller-cm5-sdk/opt/distiller-cm5-sdk/models/parakeet/
	cp -r src/distiller_cm5_sdk/piper/models $(CURDIR)/debian/distiller-cm5-sdk/opt/distiller-cm5-sdk/models/piper/
	cp -r src/distiller_cm5_sdk/piper/piper $(CURDIR)/debian/distiller-cm5-sdk/opt/distiller-cm5-sdk/models/piper/piper/
	
	# Install shared library
	install -D -m 755 src/distiller_cm5_sdk/hardware/eink/lib/libdistiller_display_sdk_shared.so \
		$(CURDIR)/debian/distiller-cm5-sdk/opt/distiller-cm5-sdk/lib/libdistiller_display_sdk_shared.so
	
	# Create system library symlink
	install -d $(CURDIR)/debian/distiller-cm5-sdk/usr/lib
	ln -sf /opt/distiller-cm5-sdk/lib/libdistiller_display_sdk_shared.so \
		$(CURDIR)/debian/distiller-cm5-sdk/usr/lib/libdistiller_display_sdk_shared.so
	
	# Install systemd service file
	install -D -m 644 debian/eink-web.service \
		$(CURDIR)/debian/distiller-cm5-sdk/lib/systemd/system/eink-web.service

override_dh_python3:
	# Skip dh_python3 - we manage Python environment with uv
	true

override_dh_strip:
	# Skip stripping for cross-compiled binaries
	true

override_dh_shlibdeps:
	# Skip shlibdeps for cross-compiled binaries
	true
