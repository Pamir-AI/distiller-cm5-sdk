#!/usr/bin/make -f

%:
	dh $@ --with python3

override_dh_auto_build:
	# No build step needed - models and library are prepared by build-deb.sh
	true

override_dh_auto_install:
	# Create the /opt/distiller-cm5-sdk directory structure
	install -d $(CURDIR)/debian/distiller-cm5-sdk/opt/distiller-cm5-sdk
	install -d $(CURDIR)/debian/distiller-cm5-sdk/opt/distiller-cm5-sdk/lib
	install -d $(CURDIR)/debian/distiller-cm5-sdk/opt/distiller-cm5-sdk/models
	install -d $(CURDIR)/debian/distiller-cm5-sdk/opt/distiller-cm5-sdk/bin
	
	# Copy Python source code (exclude Rust build dir to keep package small)
	cp -r src/distiller_cm5_sdk $(CURDIR)/debian/distiller-cm5-sdk/opt/distiller-cm5-sdk/
	# Remove embedded Rust sources/build artifacts that are not needed at run-time
	rm -rf $(CURDIR)/debian/distiller-cm5-sdk/opt/distiller-cm5-sdk/distiller_cm5_sdk/hardware/eink/lib
	
	# Copy requirements.txt
	cp requirements.txt $(CURDIR)/debian/distiller-cm5-sdk/opt/distiller-cm5-sdk/
	
	# Copy model files (must exist)
	cp -r src/distiller_cm5_sdk/parakeet/models $(CURDIR)/debian/distiller-cm5-sdk/opt/distiller-cm5-sdk/models/parakeet_models/
	cp -r src/distiller_cm5_sdk/piper/models $(CURDIR)/debian/distiller-cm5-sdk/opt/distiller-cm5-sdk/models/piper_models/
	cp -r src/distiller_cm5_sdk/piper/piper $(CURDIR)/debian/distiller-cm5-sdk/opt/distiller-cm5-sdk/models/piper_bin/
	# Ignore whisper models for now, as they are not needed for the initial release
	# cp -r src/distiller_cm5_sdk/whisper/models $(CURDIR)/debian/distiller-cm5-sdk/opt/distiller-cm5-sdk/models/whisper_models/
	
	# Install the ARM64 shared object only (no extra Rust build files)
	install -D -m 755 src/distiller_cm5_sdk/hardware/eink/lib/libdistiller_display_sdk_shared.so \
		$(CURDIR)/debian/distiller-cm5-sdk/opt/distiller-cm5-sdk/lib/libdistiller_display_sdk_shared.so
	
	# Create a symlink to the shared library in system lib for compatibility
	install -d $(CURDIR)/debian/distiller-cm5-sdk/usr/lib
	ln -sf /opt/distiller-cm5-sdk/lib/libdistiller_display_sdk_shared.so \
		$(CURDIR)/debian/distiller-cm5-sdk/usr/lib/libdistiller_display_sdk_shared.so

override_dh_python3:
	# Skip dh_python3 since we're installing to /opt
	true

override_dh_strip:
	# Skip stripping for cross-compiled binaries
	true

override_dh_shlibdeps:
	# Skip shlibdeps for cross-compiled binaries
	true
